<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Autism Data Collection Demo</title>
  <style>
    /* Global Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* Main container (max-width for top portion) */
    .container { max-width: 600px; margin: 0 auto; padding: 1rem; }
    
    /* Switch styling for lock toggles */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 24px;
      transition: 0.4s;
      text-align: center;
      line-height: 24px;
      font-size: 10px;
      font-family: Arial, sans-serif;
      color: #000;
    }
    .slider:before {
      content: "UNLOCK";
      transition: 0.4s;
    }
    input:checked + .slider {
      background-color: #c8e6c9;
    }
    input:checked + .slider:before {
      content: "LOCK";
    }
    
    /* Child Name Header */
    .child-header {
      display: flex; align-items: center; margin-bottom: 1rem;
    }
    .child-header .dropdown-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: 1rem;
    }
    .child-header label { font-weight: bold; }
    
    /* Dropdowns */
    .dropdowns { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; }
    .dropdown-row { display: flex; flex-direction: column; }
    /* New container for label and switch so the button appears immediately to the left */
    .dropdown-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }
    .dropdown-label label { font-weight: bold; }
    .dropdown-row select { width: 100%; padding: 0.3rem; }
    
    /* Instructions / SD & Notes */
    .instructions { display: flex; flex-direction: column; margin-bottom: 1rem; }
    #selectedDescription {
      font-size: 1.5em; text-align: center; background-color: red; color: white;
      padding: 10px; border-radius: 5px; margin-bottom: 1rem;
    }
    .desc-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .desc-buttons button {
      background: #0288d1; color: #fff; padding: 0.5rem 1rem; border: none;
      border-radius: 4px; cursor: pointer; white-space: nowrap;
    }
    .desc-buttons button:hover { background: #0277bd; }
    .instructions label { font-weight: bold; margin-bottom: 0.25rem; }
    .instructions textarea {
      width: 100%; padding: 0.5rem; font-size: 0.9rem; margin-bottom: 1rem; resize: vertical;
    }
    
    /* Trial Results */
    .trial-results {
      display: flex; flex-direction: row; gap: 1rem; margin-bottom: 1rem; overflow-x: auto;
    }
    .trial-results .column {
      width: 50%; display: flex; flex-direction: column; gap: 0.5rem;
    }
    label.incorrect { background-color: #ffcdd2; }
    label.independent { background-color: #c8f7c5; }
    label.verbal, label.prompted, label.modeling, label.gestural, label.partialPhysical, label.fullPhysical {
      background-color: #fff9c4;
    }
    .trial-results label {
      display: flex; align-items: center; padding: 0.5rem; border: 1px solid #ddd;
      border-radius: 4px; cursor: pointer;
    }
    .trial-results input[type="radio"] { margin-right: 0.5rem; transform: scale(1.2); }
    .trial-results label:hover { opacity: 0.9; }
    
    /* Prior Results */
    .prior-results { margin-bottom: 1rem; }
    .prior-results h2 { font-size: 1rem; margin-bottom: 0.5rem; }
    .prior-list { list-style: none; padding: 0; }
    .prior-list li { margin-bottom: 0.5rem; padding: 0.4rem; border-radius: 4px; }
    .verbal, .prompted, .modeling, .gestural, .partial-physical, .full-physical { background-color: #fff9c4; }
    .independent { background-color: #c8f7c5; }
    .incorrect { background-color: #ffcdd2; }
    
    /* Manage Data Section (full-width) */
    #dataManagementSection {
      position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw;
      width: 100vw; background: #fff; padding: 1rem 0;
    }
    #dataManagementSection hr { margin-bottom: 1rem; }
    #dataManagementSection h2 { text-align: center; margin-bottom: 1rem; }
    .data-buttons {
      display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem;
    }
    #toggleDataTableBtn, #addNewRecordBtn, #importProgramBtn, #exportTrialDataBtn {
      padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;
    }
    #toggleDataTableBtn { background: #0288d1; color: white; }
    #toggleDataTableBtn:hover { background: #0277bd; }
    #addNewRecordBtn { background: #00796b; color: white; }
    #addNewRecordBtn:hover { background: #00695c; }
    #importProgramBtn { background: #8e24aa; color: white; }
    #importProgramBtn:hover { background: #7b1fa2; }
    #exportTrialDataBtn { background: #ff9800; color: white; }
    #exportTrialDataBtn:hover { background: #fb8c00; }
    #dataTableContainer { overflow-x: auto; padding: 0 1rem; }
    #dataTable {
      width: 100%; border-collapse: collapse; margin-bottom: 2rem;
    }
    #dataTable th, #dataTable td {
      border: 1px solid #ccc; padding: 0.5rem; text-align: left;
    }
    #dataTable th { background-color: #f2f2f2; cursor: pointer; }
    /* Filter row */
    #dataTable thead tr.filterRow input {
      width: 90%; padding: 0.2rem; box-sizing: border-box;
    }
    /* Table Columns */
    .activeCheckbox { width: 16px; height: 16px; }
    .tableEditBtn {
      padding: 0.3rem 0.5rem; background: #0288d1; color: white; border: none;
      border-radius: 3px; cursor: pointer;
    }
    .tableEditBtn:hover { background: #0277bd; }
    
    /* Simple Edit Modal */
    #simpleEditModal .modal-content { max-width: 400px; }
    #simpleEditModal label { display: block; margin-top: 10px; font-weight: bold; }
    #simpleEditModal input[type="text"],
    #simpleEditModal textarea {
      width: 100%; padding: 0.3rem; margin-top: 5px; box-sizing: border-box;
    }
    #simpleEditModal button {
      margin-top: 10px; padding: 0.5rem 1rem; background: #0288d1; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    #simpleEditModal button:hover { background: #0277bd; }
    
    /* Modal container */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe; margin: 5% auto; padding: 20px;
      border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 4px;
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: black; text-decoration: none; }
  </style>
</head>
<body>
  <!-- Main App -->
  <div class="container">
    <!-- Child Name Header with Lock Toggle (child locked by default) -->
    <div class="child-header">
      <div class="dropdown-label">
        <label class="switch">
          <input type="checkbox" id="lockChild" checked>
          <span class="slider"></span>
        </label>
        <label for="childNameSelect">Child Name:</label>
      </div>
      <select id="childNameSelect"></select>
    </div>
    
    <!-- Top Section: Dropdowns for Content Area, Program, Target with Lock Toggles -->
    <div id="topSection">
      <div class="dropdowns">
        <!-- Content Area -->
        <div class="dropdown-row">
          <div class="dropdown-label">
            <label class="switch">
              <input type="checkbox" id="lockContentArea">
              <span class="slider"></span>
            </label>
            <label for="contentAreaSelect">Content Area</label>
          </div>
          <select id="contentAreaSelect"></select>
        </div>
        <!-- Program -->
        <div class="dropdown-row">
          <div class="dropdown-label">
            <label class="switch">
              <input type="checkbox" id="lockProgram">
              <span class="slider"></span>
            </label>
            <label for="programSelect">Program</label>
          </div>
          <select id="programSelect"></select>
        </div>
        <!-- Target -->
        <div class="dropdown-row">
          <div class="dropdown-label">
            <label class="switch">
              <input type="checkbox" id="lockTarget">
              <span class="slider"></span>
            </label>
            <label for="targetSelect">Target</label>
          </div>
          <select id="targetSelect"></select>
        </div>
      </div>
    </div>
    
    <!-- Instructions and SD/Notes -->
    <div class="instructions">
      <p id="selectedDescription" class="chosen-description"></p>
      <div class="desc-buttons">
        <!-- Since details are shown by default, the toggle button text is set to "Hide Details" -->
        <button id="toggleDetailsBtn">Hide Details</button>
        <button id="selectRandomBtn">Select Random</button>
      </div>
      <label for="sdInput">SD (Instruction)</label>
      <textarea id="sdInput" rows="2" placeholder='"Do the puzzle" while placing the piece...'></textarea>
      <label for="notesArea">Note</label>
      <textarea id="notesArea" rows="2" placeholder="Notes: Work Harder, Work Harder..."></textarea>
    </div>
    
    <!-- Trial Results -->
    <div class="trial-results">
      <div class="column">
        <label class="incorrect">
          <input type="radio" name="trialResult" value="incorrect" /> Incorrect
        </label>
        <label class="verbal">
          <input type="radio" name="trialResult" value="verbal" /> Verbal
        </label>
        <label class="prompted">
          <input type="radio" name="trialResult" value="prompted" /> Prompted
        </label>
        <label class="modeling">
          <input type="radio" name="trialResult" value="modeling" /> Modeling
        </label>
      </div>
      <div class="column">
        <label class="independent">
          <input type="radio" name="trialResult" value="independent" /> Independent
        </label>
        <label class="gestural">
          <input type="radio" name="trialResult" value="gestural" /> Gestural
        </label>
        <label class="partialPhysical">
          <input type="radio" name="trialResult" value="partialPhysical" /> Partial Physical
        </label>
        <label class="fullPhysical">
          <input type="radio" name="trialResult" value="fullPhysical" /> Full Physical
        </label>
      </div>
    </div>
    
    <!-- Prior Results -->
    <div class="prior-results">
      <h2>Prior Results (Current Target)</h2>
      <ul class="prior-list" id="priorList"></ul>
    </div>
  </div>
  
  <!-- Manage Data Section -->
  <div id="dataManagementSection">
    <hr/>
    <h2>Manage Data</h2>
    <div class="data-buttons">
      <button id="toggleDataTableBtn">Show Full Program</button>
      <button id="addNewRecordBtn">Add New Record</button>
      <button id="importProgramBtn">Import Program</button>
      <button id="exportTrialDataBtn">Export Trial Data CSV</button>
    </div>
    <div id="dataTableContainer" style="display: none;">
      <table id="dataTable"></table>
    </div>
  </div>
  
  <!-- Hidden CSV File Input (for CSV import) -->
  <input type="file" id="csvFileInput" accept=".csv" style="opacity: 0; position: absolute; left: -9999px;" />
  
  <!-- Simple Edit Modal (for adding/editing records) -->
  <div id="simpleEditModal" class="modal">
    <div class="modal-content">
      <span id="closeSimpleEditModal" class="close">&times;</span>
      <h2 id="simpleModalTitle">Edit Record</h2>
      <form id="simpleEditForm">
        <!-- Hidden fields to track mode ("edit" or "add") and original record keys -->
        <input type="hidden" id="simpleEditMode" value="edit">
        <input type="hidden" id="simpleOriginalChild" value="">
        <input type="hidden" id="simpleOriginalArea" value="">
        <input type="hidden" id="simpleOriginalProgram" value="">
        <input type="hidden" id="simpleOriginalTarget" value="">
        
        <!-- Fields with datalists for suggestions -->
        <label for="simpleEditChild">Child Name</label>
        <input type="text" id="simpleEditChild" list="childList" required>
        <datalist id="childList"></datalist>
        
        <label for="simpleEditContentArea">Content Area</label>
        <input type="text" id="simpleEditContentArea" list="contentAreaList" required>
        <datalist id="contentAreaList"></datalist>
        
        <label for="simpleEditProgram">Program</label>
        <input type="text" id="simpleEditProgram" list="programList" required>
        <datalist id="programList"></datalist>
        
        <label for="simpleEditTarget">Target</label>
        <input type="text" id="simpleEditTarget" list="targetList" required>
        <datalist id="targetList"></datalist>
        
        <label for="simpleEditSD">SD (Instruction)</label>
        <textarea id="simpleEditSD" required></textarea>
        
        <label for="simpleEditNote">Note</label>
        <textarea id="simpleEditNote" required></textarea>
        
        <!-- Active checkbox (for new records) -->
        <label>
          <input type="checkbox" id="simpleEditActive"> Active
        </label>
        
        <button type="submit" id="simpleSaveEditBtn">Save</button>
        <button type="button" id="simpleCancelEditBtn">Cancel</button>
      </form>
    </div>
  </div>
  
  <!-- Datalists for Simple Edit Modal -->
  <datalist id="childList"></datalist>
  <datalist id="contentAreaList"></datalist>
  <datalist id="programList"></datalist>
  <datalist id="targetList"></datalist>
  
  <!-- Consolidated Script Block -->
  <script>
    /******** Global Variables ********/
    let trialHistory = [];
    let sortOrder = 1;
    
    /******** Local Storage Functions ********/
    function loadAppData() {
      const stored = localStorage.getItem("appData");
      if (stored) {
        try { return JSON.parse(stored); }
        catch (e) { console.error("Error parsing appData", e); }
      }
      return null;
    }
    function saveAppData() {
      localStorage.setItem("appData", JSON.stringify(appData));
    }
    
    /******** Global Data Structure ********/
    let appData = loadAppData();
    if (!appData || Object.keys(appData).length === 0) {
      // Default sample data
      appData = {
        "Test Child": {
          "Math Skills": {
            "Counting": {
              "Count to 10": { sd: "Count from 1 to 10", note: "Encourage counting", active: true }
            },
            "Shapes": {
              "Identify Circle": { sd: "Identify the circle", note: "Provide visual cues", active: true }
            }
          },
          "Language Skills": {
            "Naming": {
              "Name Colors": { sd: "Name the color", note: "Use flashcards", active: true }
            }
          }
        },
        "Joe Smith": {
          "Visual - Performance": {
            "Single Puzzle": {
              "Puzzle - 1 piece": { sd: '"Do the puzzle" while placing the piece...', note: "Use both hands", active: true },
              "Puzzle - 2 pieces": { sd: '"Do the puzzle" with two pieces...', note: "Encourage problem solving", active: true }
            },
            "Matching": {
              "Color Matching": { sd: '"Match the colors"', note: "Use visual cues", active: true }
            }
          }
        },
        "Jane Doe": {
          "Language - Receptive": {
            "Imitation": {
              "Tracing Letters": { sd: '"Trace the letters"', note: "Focus on letter shapes", active: true }
            },
            "Labeling (Tacts)": {
              "Conversation Skills": { sd: '"Talk about daily activities"', note: "Prompt with questions", active: true }
            }
          }
        },
        "Bob Johnson": {
          "Social Skills": {
            "Social Greetings": {
              "Greeting by name": { sd: '"Say hello to your friend"', note: "Maintain eye contact", active: true }
            },
            "Adaptive Skills": {
              "Sharing Toys": { sd: '"Share your toys with a peer"', note: "Praise sharing behavior", active: true }
            }
          }
        }
      };
      saveAppData();
    }
    
    /******** Helper: Check if a child has any active record ********/
    function childHasActiveRecords(childName) {
      if (!appData[childName]) return false;
      for (const area in appData[childName]) {
        for (const program in appData[childName][area]) {
          for (const target in appData[childName][area][program]) {
            if (appData[childName][area][program][target].active) {
              return true;
            }
          }
        }
      }
      return false;
    }
    
    /******** Functions for Main Interface ********/
    const childNameSelect = document.getElementById("childNameSelect");
    const contentAreaSelect = document.getElementById("contentAreaSelect");
    const programSelect = document.getElementById("programSelect");
    const targetSelect = document.getElementById("targetSelect");
    const sdInput = document.getElementById("sdInput");
    const notesArea = document.getElementById("notesArea");
    const descriptionP = document.getElementById("selectedDescription");
    const priorList = document.getElementById("priorList");
    
    function populateChildNames() {
      childNameSelect.innerHTML = "";
      const validChildren = Object.keys(appData).filter(child => childHasActiveRecords(child));
      validChildren.forEach(child => {
        const opt = document.createElement("option");
        opt.value = child;
        opt.textContent = child;
        childNameSelect.appendChild(opt);
      });
      if (!validChildren.includes(childNameSelect.value) && validChildren.length) {
        childNameSelect.value = validChildren[0];
      }
    }
    function updateContentAreas() {
      const selectedChild = childNameSelect.value;
      contentAreaSelect.innerHTML = "";
      if (appData[selectedChild]) {
        Object.keys(appData[selectedChild]).forEach(area => {
          const opt = document.createElement("option");
          opt.value = area;
          opt.textContent = area;
          contentAreaSelect.appendChild(opt);
        });
      }
    }
    function updateProgramSelect() {
      const selectedChild = childNameSelect.value;
      const selectedArea = contentAreaSelect.value;
      programSelect.innerHTML = "";
      if (appData[selectedChild] && appData[selectedChild][selectedArea]) {
        Object.keys(appData[selectedChild][selectedArea]).forEach(prog => {
          const opt = document.createElement("option");
          opt.value = prog;
          opt.textContent = prog;
          programSelect.appendChild(opt);
        });
      }
    }
    function updateTargetSelect() {
      const selectedChild = childNameSelect.value;
      const selectedArea = contentAreaSelect.value;
      const selectedProgram = programSelect.value;
      targetSelect.innerHTML = "";
      if (appData[selectedChild] &&
          appData[selectedChild][selectedArea] &&
          appData[selectedChild][selectedArea][selectedProgram]) {
        Object.keys(appData[selectedChild][selectedArea][selectedProgram])
          .filter(target => appData[selectedChild][selectedArea][selectedProgram][target].active)
          .forEach(target => {
            const opt = document.createElement("option");
            opt.value = target;
            opt.textContent = target;
            targetSelect.appendChild(opt);
          });
      }
    }
    function updateInstructions() {
      const selectedChild = childNameSelect.value;
      const selectedArea = contentAreaSelect.value;
      const selectedProgram = programSelect.value;
      const selectedTarget = targetSelect.value;
      if (appData[selectedChild] &&
          appData[selectedChild][selectedArea] &&
          appData[selectedChild][selectedArea][selectedProgram] &&
          appData[selectedChild][selectedArea][selectedProgram][selectedTarget]) {
        const rec = appData[selectedChild][selectedArea][selectedProgram][selectedTarget];
        sdInput.value = rec.sd;
        notesArea.value = rec.note;
      } else {
        sdInput.value = "";
        notesArea.value = "";
      }
    }
    function updateDescription() {
      const selectedChild = childNameSelect.value;
      descriptionP.textContent = selectedChild + ' -- ' + contentAreaSelect.value + ' -- ' + programSelect.value + ' -- ' + targetSelect.value;
    }
    function updatePriorResults() {
      const selectedChild = childNameSelect.value;
      const currentArea = contentAreaSelect.value;
      const currentProgram = programSelect.value;
      const currentTarget = targetSelect.value;
      const filtered = trialHistory.filter(item => 
        item.child === selectedChild &&
        item.contentArea === currentArea &&
        item.program === currentProgram &&
        item.target === currentTarget
      );
      const lastFive = filtered.slice(-5);
      priorList.innerHTML = "";
      for (let i = lastFive.length - 1; i >= 0; i--) {
        const li = document.createElement("li");
        li.textContent = lastFive[i].result.charAt(0).toUpperCase() + lastFive[i].result.slice(1);
        li.className = lastFive[i].result;
        priorList.appendChild(li);
      }
    }
    
    childNameSelect.addEventListener('change', () => {
      updateContentAreas();
      updateProgramSelect();
      updateTargetSelect();
      updateInstructions();
      updateDescription();
      updatePriorResults();
    });
    contentAreaSelect.addEventListener('change', () => {
      updateProgramSelect();
      updateTargetSelect();
      updateInstructions();
      updateDescription();
      updatePriorResults();
    });
    programSelect.addEventListener('change', () => {
      updateTargetSelect();
      updateInstructions();
      updateDescription();
      updatePriorResults();
    });
    targetSelect.addEventListener('change', () => {
      updateInstructions();
      updateDescription();
      updatePriorResults();
    });
    
    populateChildNames();
    updateContentAreas();
    updateProgramSelect();
    updateTargetSelect();
    updateInstructions();
    updateDescription();
    updatePriorResults();
    
    /******** Randomization Functionality with Lock Checks ********/
    function randomizeTrialData() {
      const lockChild = document.getElementById('lockChild').checked;
      const lockContentArea = document.getElementById('lockContentArea').checked;
      const lockProgram = document.getElementById('lockProgram').checked;
      const lockTarget = document.getElementById('lockTarget').checked;
      
      if (!lockChild) {
        const validChildren = Object.keys(appData).filter(child => childHasActiveRecords(child));
        if (validChildren.length > 0) {
          const randomChild = validChildren[Math.floor(Math.random() * validChildren.length)];
          childNameSelect.value = randomChild;
        }
      }
      const selectedChild = childNameSelect.value;
      if (!appData[selectedChild]) return;
      const childData = appData[selectedChild];
      
      if (!lockContentArea) {
        const contentAreas = Object.keys(childData);
        if (contentAreas.length > 0) {
          const randomArea = contentAreas[Math.floor(Math.random() * contentAreas.length)];
          contentAreaSelect.value = randomArea;
        }
      }
      updateProgramSelect();
      
      if (!lockProgram) {
        const programs = Object.keys(childData[contentAreaSelect.value] || {});
        if (programs.length > 0) {
          const randomProgram = programs[Math.floor(Math.random() * programs.length)];
          programSelect.value = randomProgram;
        }
      }
      updateTargetSelect();
      
      if (!lockTarget) {
        const targets = Object.keys(childData[contentAreaSelect.value][programSelect.value] || {})
                        .filter(t => childData[contentAreaSelect.value][programSelect.value][t].active);
        if (targets.length > 0) {
          const randomTarget = targets[Math.floor(Math.random() * targets.length)];
          targetSelect.value = randomTarget;
        }
      }
      updateInstructions();
      updateDescription();
      updatePriorResults();
    }
    document.getElementById('selectRandomBtn').addEventListener('click', randomizeTrialData);
    
    /******** Toggle Details Section ********/
    const toggleBtn = document.getElementById('toggleDetailsBtn');
    toggleBtn.addEventListener('click', () => {
      const topSection = document.getElementById('topSection');
      // Use computed style to check current display state
      const currentDisplay = window.getComputedStyle(topSection).display;
      if (currentDisplay === 'none') {
        topSection.style.display = 'block';
        toggleBtn.textContent = 'Hide Details';
      } else {
        topSection.style.display = 'none';
        toggleBtn.textContent = 'View Details';
      }
    });
    
    /******** Trial Data Recording with Confirmation Popup ********/
    function clearTrialSelection() {
      document.querySelectorAll('input[name="trialResult"]').forEach(radio => {
        radio.checked = false;
      });
    }
    function recordTrial(result) {
      alert("Trial data recorded: " + result);
      const record = {
        child: childNameSelect.value,
        contentArea: contentAreaSelect.value,
        program: programSelect.value,
        target: targetSelect.value,
        result: result,
        timestamp: new Date().toISOString()
      };
      trialHistory.push(record);
      updatePriorResults();
      randomizeTrialData();
      clearTrialSelection();
    }
    document.querySelectorAll('input[name="trialResult"]').forEach(radio => {
      radio.addEventListener('change', e => { recordTrial(e.target.value); });
    });
    
    /******** CSV Import Functionality ********/
    const importProgramBtn = document.getElementById('importProgramBtn');
    const csvFileInput = document.getElementById('csvFileInput');
    
    importProgramBtn.addEventListener('click', () => { csvFileInput.click(); });
    
    csvFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseCSVImport(text);
        csvFileInput.value = "";
      };
      reader.readAsText(file);
    });
    
    function parseCSVImport(csvText) {
      const lines = csvText.split(/\r?\n/);
      if (lines.length < 2) return alert("CSV file appears empty.");
      const header = lines[0].split(",").map(h => h.trim().toLowerCase());
      const expected = ["child", "content area", "program", "target", "sd", "note", "active"];
      if (header.join() !== expected.join()) {
        return alert("CSV header does not match expected format. Expected: " + expected.join(", "));
      }
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const fields = line.split(",").map(f => f.trim());
        if (fields.length < 7) continue;
        const [child, area, program, target, sd, note, activeStr] = fields;
        const active = (activeStr.toLowerCase() === "true" || activeStr === "1");
        if (!appData[child]) { appData[child] = {}; }
        if (!appData[child][area]) { appData[child][area] = {}; }
        if (!appData[child][area][program]) { appData[child][area][program] = {}; }
        appData[child][area][program][target] = { sd: sd, note: note, active: active };
      }
      saveAppData();
      populateChildNames();
      updateContentAreas();
      updateProgramSelect();
      updateTargetSelect();
      updateInstructions();
      updateDescription();
      alert("CSV import successful.");
    }
    
    /******** Export Trial Data as CSV ********/
    const exportTrialDataBtn = document.getElementById("exportTrialDataBtn");
    exportTrialDataBtn.addEventListener("click", exportTrialData);
    
    function exportTrialData() {
      if (trialHistory.length === 0) {
        alert("No trial data to export.");
        return;
      }
      const header = ["Child", "Content Area", "Program", "Target", "Result", "Timestamp"];
      let csvContent = header.join(",") + "\n";
      trialHistory.forEach(record => {
        const row = [
          record.child,
          record.contentArea,
          record.program,
          record.target,
          record.result,
          record.timestamp
        ];
        csvContent += row.map(v => `"${v}"`).join(",") + "\n";
      });
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trial_data.csv";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    /******** Simple Edit Modal (for adding/editing records) ********/
    const simpleEditModal = document.getElementById('simpleEditModal');
    const closeSimpleEditModal = document.getElementById('closeSimpleEditModal');
    const simpleEditForm = document.getElementById('simpleEditForm');
    const simpleModalTitle = document.getElementById('simpleModalTitle');
    const simpleEditChild = document.getElementById('simpleEditChild');
    const simpleEditContentArea = document.getElementById('simpleEditContentArea');
    const simpleEditProgram = document.getElementById('simpleEditProgram');
    const simpleEditTarget = document.getElementById('simpleEditTarget');
    const simpleEditSD = document.getElementById('simpleEditSD');
    const simpleEditNote = document.getElementById('simpleEditNote');
    const simpleEditActive = document.getElementById('simpleEditActive');
    const simpleOriginalChild = document.getElementById('simpleOriginalChild');
    const simpleOriginalArea = document.getElementById('simpleOriginalArea');
    const simpleOriginalProgram = document.getElementById('simpleOriginalProgram');
    const simpleOriginalTarget = document.getElementById('simpleOriginalTarget');
    
    // Datalist update functions
    function updateChildDatalist() {
      const datalist = document.getElementById('childList');
      datalist.innerHTML = "";
      Object.keys(appData).forEach(child => {
        const option = document.createElement('option');
        option.value = child;
        datalist.appendChild(option);
      });
    }
    function updateContentAreaDatalist() {
      const datalist = document.getElementById('contentAreaList');
      datalist.innerHTML = "";
      const childVal = simpleEditChild.value;
      if (appData[childVal]) {
        Object.keys(appData[childVal]).forEach(area => {
          const option = document.createElement('option');
          option.value = area;
          datalist.appendChild(option);
        });
      }
    }
    function updateProgramDatalist() {
      const datalist = document.getElementById('programList');
      datalist.innerHTML = "";
      const childVal = simpleEditChild.value;
      const areaVal = simpleEditContentArea.value;
      if (appData[childVal] && appData[childVal][areaVal]) {
        Object.keys(appData[childVal][areaVal]).forEach(prog => {
          const option = document.createElement('option');
          option.value = prog;
          datalist.appendChild(option);
        });
      }
    }
    function updateTargetDatalist() {
      const datalist = document.getElementById('targetList');
      datalist.innerHTML = "";
      const childVal = simpleEditChild.value;
      const areaVal = simpleEditContentArea.value;
      const progVal = simpleEditProgram.value;
      if (appData[childVal] && appData[childVal][areaVal] && appData[childVal][areaVal][progVal]) {
        Object.keys(appData[childVal][areaVal][progVal]).forEach(targ => {
          const option = document.createElement('option');
          option.value = targ;
          datalist.appendChild(option);
        });
      }
    }
    simpleEditChild.addEventListener('input', updateContentAreaDatalist);
    simpleEditContentArea.addEventListener('input', updateProgramDatalist);
    simpleEditProgram.addEventListener('input', updateTargetDatalist);
    
    function openSimpleEditModal(data, mode) {
      document.getElementById('simpleEditMode').value = mode;
      if (mode === "edit") {
        simpleModalTitle.textContent = "Edit Record";
        simpleEditChild.value = data.child || "";
        simpleEditContentArea.value = data.area || "";
        simpleEditProgram.value = data.program || "";
        simpleEditTarget.value = data.target || "";
        simpleEditSD.value = data.sd || "";
        simpleEditNote.value = data.note || "";
        simpleEditActive.checked = (data.active === false ? false : true);
        simpleOriginalChild.value = data.child || "";
        simpleOriginalArea.value = data.area || "";
        simpleOriginalProgram.value = data.program || "";
        simpleOriginalTarget.value = data.target || "";
      } else if (mode === "add") {
        simpleModalTitle.textContent = "Add New Record";
        simpleEditChild.value = childNameSelect.value;
        simpleEditContentArea.value = "";
        simpleEditProgram.value = "";
        simpleEditTarget.value = "";
        simpleEditSD.value = "";
        simpleEditNote.value = "";
        simpleEditActive.checked = false;
        simpleOriginalChild.value = "";
        simpleOriginalArea.value = "";
        simpleOriginalProgram.value = "";
        simpleOriginalTarget.value = "";
      }
      updateChildDatalist();
      updateContentAreaDatalist();
      updateProgramDatalist();
      updateTargetDatalist();
      simpleEditModal.style.display = "block";
    }
    function closeSimpleEditModalFunc() { simpleEditModal.style.display = "none"; }
    document.getElementById('closeSimpleEditModal').addEventListener('click', closeSimpleEditModalFunc);
    document.getElementById('simpleCancelEditBtn').addEventListener('click', closeSimpleEditModalFunc);
    
    simpleEditForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const mode = document.getElementById('simpleEditMode').value;
      const newChild = simpleEditChild.value.trim();
      const newArea = simpleEditContentArea.value.trim();
      const newProg = simpleEditProgram.value.trim();
      const newTarget = simpleEditTarget.value.trim();
      const newSD = simpleEditSD.value.trim();
      const newNote = simpleEditNote.value.trim();
      const newActive = simpleEditActive.checked;
      
      if (!newChild || !newArea || !newProg || !newTarget || !newSD || !newNote) {
        alert("All fields are required.");
        return;
      }
      
      if (mode === "edit") {
        const origChild = simpleOriginalChild.value;
        const origArea = simpleOriginalArea.value;
        const origProg = simpleOriginalProgram.value;
        const origTarget = simpleOriginalTarget.value;
        if (origChild && origArea && origProg && origTarget) {
          delete appData[origChild][origArea][origProg][origTarget];
          if (Object.keys(appData[origChild][origArea][origProg]).length === 0) {
            delete appData[origChild][origArea][origProg];
            if (Object.keys(appData[origChild][origArea]).length === 0) {
              delete appData[origChild][origArea];
              if (Object.keys(appData[origChild]).length === 0) {
                delete appData[origChild];
              }
            }
          }
        }
      }
      if (!appData[newChild]) { appData[newChild] = {}; }
      if (!appData[newChild][newArea]) { appData[newChild][newArea] = {}; }
      if (!appData[newChild][newArea][newProg]) { appData[newChild][newArea][newProg] = {}; }
      if (mode === "add" && appData[newChild][newArea][newProg][newTarget]) {
        if (!confirm("Target already exists. Overwrite?")) { return; }
      }
      appData[newChild][newArea][newProg][newTarget] = { sd: newSD, note: newNote, active: newActive };
      closeSimpleEditModalFunc();
      buildDataTable();
      if (childNameSelect.value === simpleOriginalChild.value &&
          contentAreaSelect.value === simpleOriginalArea.value &&
          programSelect.value === simpleOriginalProgram.value &&
          targetSelect.value === simpleOriginalTarget.value) {
        childNameSelect.value = newChild;
        updateContentAreas();
        contentAreaSelect.value = newArea;
        updateProgramSelect();
        programSelect.value = newProg;
        updateTargetSelect();
        targetSelect.value = newTarget;
        updateInstructions();
        updateDescription();
        updatePriorResults();
      }
      saveAppData();
    });
    
    /******** New Button for Adding New Record ********/
    document.getElementById('addNewRecordBtn').addEventListener('click', function() {
      openSimpleEditModal({}, "add");
    });
    
    /******** Data Management: Table View ********/
    function buildDataTable() {
      let rows = [];
      Object.keys(appData).forEach(child => {
        Object.keys(appData[child]).forEach(area => {
          Object.keys(appData[child][area]).forEach(prog => {
            Object.keys(appData[child][area][prog]).forEach(targ => {
              const rec = appData[child][area][prog][targ];
              rows.push({
                child: child,
                contentArea: area,
                program: prog,
                target: targ,
                sd: rec.sd,
                note: rec.note,
                active: rec.active
              });
            });
          });
        });
      });
      
      const columns = ["Child", "Active", "Content Area", "Program", "Target", "SD", "Note", "Action"];
      let thead = "<thead><tr>";
      columns.forEach((col, index) => {
        if (col !== "Action") {
          thead += `<th data-col="${index}" class="sortable">${col}</th>`;
        } else {
          thead += `<th>${col}</th>`;
        }
      });
      thead += "</tr>";
      thead += "<tr class='filterRow'>";
      columns.forEach((col, index) => {
        if (col === "Active" || col === "Action") {
          thead += "<th></th>";
        } else {
          thead += `<th><input type="text" data-col="${index}" placeholder="Filter ${col}" /></th>`;
        }
      });
      thead += "</tr></thead>";
      
      let tbody = "<tbody>";
      rows.forEach(row => {
        tbody += "<tr>";
        tbody += `<td>${row.child}</td>`;
        tbody += `<td style="text-align: center;"><input type="checkbox" class="activeCheckbox" data-child="${row.child}" data-contentArea="${row.contentArea}" data-program="${row.program}" data-target="${row.target}" ${row.active ? "checked" : ""} /></td>`;
        tbody += `<td>${row.contentArea}</td>`;
        tbody += `<td>${row.program}</td>`;
        tbody += `<td>${row.target}</td>`;
        tbody += `<td>${row.sd}</td>`;
        tbody += `<td>${row.note}</td>`;
        tbody += `<td><button class="tableEditBtn" data-child="${row.child}" data-contentArea="${row.contentArea}" data-program="${row.program}" data-target="${row.target}">Edit</button></td>`;
        tbody += "</tr>";
      });
      tbody += "</tbody>";
      
      dataTable.innerHTML = thead + tbody;
      
      const sortableHeaders = dataTable.querySelectorAll("th.sortable");
      sortableHeaders.forEach(header => {
        header.addEventListener("click", () => {
          const colIndex = header.getAttribute("data-col");
          sortTable(colIndex);
        });
      });
      
      const filterInputs = dataTable.querySelectorAll("thead tr.filterRow input");
      filterInputs.forEach(input => {
        input.addEventListener("keyup", filterTable);
      });
      
      const editButtons = dataTable.querySelectorAll(".tableEditBtn");
      editButtons.forEach(btn => {
        btn.addEventListener("click", function() {
          const child = btn.getAttribute("data-child");
          const area = btn.getAttribute("data-contentArea");
          const prog = btn.getAttribute("data-program");
          const targ = btn.getAttribute("data-target");
          const rec = appData[child][area][prog][targ];
          openSimpleEditModal({ child, area, program: prog, target: targ, sd: rec.sd, note: rec.note, active: rec.active }, "edit");
        });
      });
      
      const activeCheckboxes = dataTable.querySelectorAll(".activeCheckbox");
      activeCheckboxes.forEach(chk => {
        chk.addEventListener("change", function() {
          const child = chk.getAttribute("data-child");
          const area = chk.getAttribute("data-contentArea");
          const prog = chk.getAttribute("data-program");
          const targ = chk.getAttribute("data-target");
          appData[child][area][prog][targ].active = chk.checked;
          updateTargetSelect();
          updateInstructions();
          updateDescription();
          updatePriorResults();
          saveAppData();
        });
      });
    }
    
    function sortTable(colIndex) {
      const tbody = dataTable.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a, b) => {
        const aText = a.children[colIndex].textContent.toLowerCase();
        const bText = b.children[colIndex].textContent.toLowerCase();
        if (aText < bText) return -1 * sortOrder;
        if (aText > bText) return 1 * sortOrder;
        return 0;
      });
      sortOrder *= -1;
      rows.forEach(row => tbody.appendChild(row));
    }
    
    function filterTable() {
      const filters = {};
      const inputs = dataTable.querySelectorAll("thead tr.filterRow input");
      inputs.forEach(input => {
        const col = input.getAttribute("data-col");
        filters[col] = input.value.toLowerCase();
      });
      const tbody = dataTable.querySelector("tbody");
      const rows = tbody.querySelectorAll("tr");
      rows.forEach(row => {
        let show = true;
        for (let i = 1; i < row.children.length - 1; i++) {
          const cellText = row.children[i].textContent.toLowerCase();
          if (filters[i+1] && !cellText.includes(filters[i+1])) {
            show = false;
            break;
          }
        }
        row.style.display = show ? "" : "none";
      });
    }
    
    document.getElementById('toggleDataTableBtn').addEventListener("click", function() {
      const container = document.getElementById('dataTableContainer');
      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
        this.textContent = "Hide Full Program";
        buildDataTable();
      } else {
        container.style.display = "none";
        this.textContent = "Show Full Program";
      }
    });
    
    /******** Close modal if click outside ********/
    window.addEventListener('click', function(e) {
      if (e.target == simpleEditModal) { closeSimpleEditModalFunc(); }
    });
  </script>
</body>
</html>
